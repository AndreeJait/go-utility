name: Tag on Push to Master

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  create_tag_and_release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # fetch all history including tags

      - name: Fetch tags
        run: git fetch --tags --force

      # Prefer git tags over releases/latest (more reliable)
      - name: Get latest tag (git)
        id: get_latest_tag
        run: |
          latest_tag=$(git tag --list 'v*' --sort=-v:refname | head -n 1)
          echo "latest_tag=$latest_tag" >> "$GITHUB_OUTPUT"
          echo "Latest tag: ${latest_tag:-<none>}"

      - name: Calculate new tag (semver-ish)
        id: calculate_new_tag
        run: |
          latest_tag="${{ steps.get_latest_tag.outputs.latest_tag }}"

          if [ -z "$latest_tag" ]; then
            new_tag="v0.0.1"
          else
            version="${latest_tag#v}"
            IFS='.' read -r major minor patch <<< "$version"

            major=${major:-0}
            minor=${minor:-0}
            patch=${patch:-0}

            # your logic: patch increments, rollover patch>=9 => minor++, minor>=10 => major++
            if [ "$patch" -ge 9 ]; then
              minor=$((minor + 1))
              patch=0
            else
              patch=$((patch + 1))
            fi

            if [ "$minor" -ge 10 ]; then
              major=$((major + 1))
              minor=0
            fi

            new_tag="v$major.$minor.$patch"
          fi

          echo "new_tag=$new_tag" >> "$GITHUB_OUTPUT"
          echo "Calculated new tag: $new_tag"

      # Keep bumping until we find a tag that doesn't exist on remote
      - name: Ensure tag is unique (remote)
        id: ensure_unique_tag
        run: |
          bump() {
            local tag="$1"
            local version="${tag#v}"
            IFS='.' read -r major minor patch <<< "$version"
            major=${major:-0}; minor=${minor:-0}; patch=${patch:-0}

            if [ "$patch" -ge 9 ]; then
              minor=$((minor + 1))
              patch=0
            else
              patch=$((patch + 1))
            fi
            if [ "$minor" -ge 10 ]; then
              major=$((major + 1))
              minor=0
            fi
            echo "v$major.$minor.$patch"
          }

          candidate="${{ steps.calculate_new_tag.outputs.new_tag }}"

          while git ls-remote --tags origin "refs/tags/$candidate" | grep -q "refs/tags/$candidate"; do
            echo "Tag exists on remote: $candidate -> bumping..."
            candidate="$(bump "$candidate")"
          done

          echo "final_tag=$candidate" >> "$GITHUB_OUTPUT"
          echo "Final unique tag: $candidate"

      - name: Configure Git and Create Tag + update latest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          new_tag="${{ steps.ensure_unique_tag.outputs.final_tag }}"
          git tag "$new_tag"
          git push origin "$new_tag"

          # Update the "latest" tag to point to the newly created tag
          git tag -f latest "$new_tag"
          git push -f origin latest

      - name: Generate changelog
        id: generate_changelog
        run: |
          previous_tag="${{ steps.get_latest_tag.outputs.latest_tag }}"
          new_tag="${{ steps.ensure_unique_tag.outputs.final_tag }}"

          if [ -z "$previous_tag" ]; then
            changelog=$(git log --pretty=format:"- %s%n" --reverse HEAD)
          else
            changelog=$(git log --pretty=format:"- %s%n" "$previous_tag"..HEAD)
          fi

          {
            echo "changelog<<EOF"
            echo "$changelog"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "Previous tag: ${previous_tag:-<none>}"
          echo "New tag: $new_tag"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ensure_unique_tag.outputs.final_tag }}
          body: |
            Release created automatically by GitHub Actions.

            Changes since previous tag (${{ steps.get_latest_tag.outputs.latest_tag }}):
            ${{ steps.generate_changelog.outputs.changelog }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
